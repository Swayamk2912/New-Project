{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FreelanceHub{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto flex justify-between items-center py-4 px-6">
            <a href="{% url 'home' %}" class="text-2xl font-bold text-purple-600">FreelanceHub</a>
            <div class="space-x-4 flex items-center">
                {% if user.is_authenticated %}
                <div class="relative">
                    <button id="notification-bell" class="text-gray-600 hover:text-purple-600 focus:outline-none">
                        <i class="fas fa-bell"></i>
                        {% if total_notifications > 0 %}
                            <span id="notification-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">{{ total_notifications }}</span>
                        {% else %}
                            <span id="notification-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                        {% endif %}
                    </button>
                    <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-20">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="notification-bell">
                            {% if total_notifications == 0 %}
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 no-notifications" role="menuitem">No new notifications</a>
                            {% endif %}
                            <!-- Notifications will be added here by WebSocket -->
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if not user.is_authenticated or user.role == 'freelancer' %}
                    <a href="{% url 'jobs:job-list' %}" class="text-gray-600 hover:text-purple-600">Jobs</a>
                {% endif %}
                {% if user.is_authenticated and user.role == 'freelancer' %}
                    <a href="{% url 'proposals:my_proposals' %}" class="text-gray-600 hover:text-purple-600">My Proposals</a>
                {% elif user.is_authenticated and user.role == 'client' %}
                    <a href="{% url 'proposals:job_proposals' %}" class="text-gray-600 hover:text-purple-600">Proposals Received</a>
                    <a href="{% url 'users:freelancer_list' %}" class="text-gray-600 hover:text-purple-600">Freelancers</a>
                {% endif %}
                {% if user.is_authenticated %}
                    <a href="{% url 'messaging:inbox' %}" class="relative text-gray-600 hover:text-purple-600">
                        Inbox
                        {% if unread_messages > 0 %}
                            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">{{ unread_messages }}</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'users:profile' %}" class="text-gray-600 hover:text-purple-600">Dashboard</a>
                    <a href="{% url 'users:logout' %}" class="text-red-600 hover:text-red-800">Logout</a>
                    <span class="text-gray-600">Hello, {{ user.username }}!</span>
                {% else %}
                    <a href="{% url 'users:login' %}" class="text-gray-600 hover:text-purple-600">Login</a>
                    <a href="{% url 'users:register' %}" class="bg-purple-600 text-white px-3 py-1 rounded-lg">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto mt-4 px-4">
        {% if messages %}
            {% for message in messages %}
                <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    {% block content %}{% endblock %}

    <!-- Footer -->
    <footer class="bg-gray-900 text-white text-center py-6 mt-12">
        <p>&copy; 2025 FreelanceHub. All rights reserved.</p>
    </footer>

    {% if user.is_authenticated %}
    <script>
        const userId = "{{ user.id }}";
        const notificationSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/notifications/'
        );

        notificationSocket.onopen = function(e) {
            console.log("Notification WebSocket connected.");
        };

        notificationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Notification received:", data);

            // Update notification count
            const notificationCountSpan = document.getElementById('notification-count');
            let currentCount = parseInt(notificationCountSpan.innerText);
            notificationCountSpan.innerText = currentCount + 1;
            notificationCountSpan.classList.remove('hidden'); // Ensure it's visible

            // Add notification to dropdown
            const notificationDropdown = document.getElementById('notification-dropdown').querySelector('div');
            const newNotificationLink = document.createElement('a');
            newNotificationLink.href = "#"; // Link to notification detail page if available
            newNotificationLink.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100');
            newNotificationLink.innerText = data.verb; // Display the notification verb
            notificationDropdown.prepend(newNotificationLink); // Add to top of dropdown

            // Remove "No new notifications" if present
            const noNotifications = notificationDropdown.querySelector('.no-notifications');
            if (noNotifications) {
                noNotifications.remove();
            }
        };

        notificationSocket.onclose = function(e) {
            console.error('Notification WebSocket closed unexpectedly');
        };

        notificationSocket.onerror = function(e) {
            console.error('Notification WebSocket error:', e);
        };

        // Toggle notification dropdown
        const notificationBell = document.getElementById('notification-bell');
        const notificationDropdown = document.getElementById('notification-dropdown');

        notificationBell.addEventListener('click', function() {
            notificationDropdown.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        window.addEventListener('click', function(e) {
            if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });

        // Initial fetch for unread notifications (optional, can be done via an API endpoint)
        // For now, we'll assume the count starts at 0 and updates via WebSocket
        // You might want an API endpoint to fetch initial unread count and recent notifications
        document.addEventListener('DOMContentLoaded', function() {
            const notificationCountSpan = document.getElementById('notification-count');
            if (notificationCountSpan.innerText === '0') {
                notificationCountSpan.classList.add('hidden');
            }
            // Placeholder for initial notifications if needed
            const notificationDropdownContent = document.getElementById('notification-dropdown').querySelector('div');
            if (notificationDropdownContent.children.length === 0) {
                const noNotificationsLink = document.createElement('a');
                noNotificationsLink.href = "#";
                noNotificationsLink.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'no-notifications');
                noNotificationsLink.innerText = "No new notifications";
                notificationDropdownContent.appendChild(noNotificationsLink);
            }
        });

    </script>
    {% endif %}
</body>
</html>
