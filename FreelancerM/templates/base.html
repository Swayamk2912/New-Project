{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FreelanceHub{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;606;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto flex justify-between items-center py-4 px-6">
            <a href="{% url 'home' %}" class="text-2xl font-bold text-purple-600">FreelanceHub</a>
            <div class="space-x-4 flex items-center">
                {% if user.is_authenticated %}
                <div class="relative">
                    <button id="notification-bell" class="text-gray-600 hover:text-purple-600 focus:outline-none">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                    </button>
                    <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-20">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="notification-bell">
                            <!-- Notifications will be added here by WebSocket -->
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 no-notifications" role="menuitem">No new notifications</a>
                        </div>
                        <div class="border-t border-gray-200">
                            <button id="mark-all-read-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:outline-none">Mark all as read</button>
                            <a href="{% url 'notifications:notification_list' %}" class="block px-4 py-2 text-sm text-purple-600 hover:bg-gray-100">View All Notifications</a>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if not user.is_authenticated or user.role == 'freelancer' %}
                    <a href="{% url 'jobs:job-list' %}" class="text-gray-600 hover:text-purple-600">Jobs</a>
                {% endif %}
                {% if user.is_authenticated and user.role == 'freelancer' %}
                    <a href="{% url 'proposals:my_proposals' %}" class="text-gray-600 hover:text-purple-600">My Proposals</a>
                {% elif user.is_authenticated and user.role == 'client' %}
                    <a href="{% url 'proposals:job_proposals' %}" class="text-gray-600 hover:text-purple-600">Proposals Received</a>
                    <a href="{% url 'users:freelancer_list' %}" class="text-gray-600 hover:text-purple-600">Freelancers</a>
                {% endif %}
                {% if user.is_authenticated %}
                    <a href="{% url 'messaging:inbox' %}" class="relative text-gray-600 hover:text-purple-600">
                        Inbox
                        {% if unread_messages > 0 %}
                            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">{{ unread_messages }}</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'users:profile' %}" class="text-gray-600 hover:text-purple-600">Dashboard</a>
                    <a href="{% url 'users:logout' %}" class="text-red-600 hover:text-red-800">Logout</a>
                    <span class="text-gray-600">Hello, {{ user.username }}! ({{ user.role|capfirst }})</span>
                {% else %}
                    <a href="{% url 'users:login' %}" class="text-gray-600 hover:text-purple-600">Login</a>
                    <a href="{% url 'users:register' %}" class="bg-purple-600 text-white px-3 py-1 rounded-lg">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
   
    {% block content %}{% endblock %}

    <!-- Footer -->
    <footer class="bg-gray-900 text-white text-center py-6 mt-12">
        <p>&copy; 2025 FreelanceHub. All rights reserved.</p>
    </footer>

    {% if user.is_authenticated %}
    <script>
        const userId = "{{ user.id }}";
        const notificationCountSpan = document.getElementById('notification-count');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationDropdownContent = notificationDropdown.querySelector('div');
        const notificationBell = document.getElementById('notification-bell');
        const markAllReadBtn = document.getElementById('mark-all-read-btn');

        function updateNotificationCount(count) {
            notificationCountSpan.innerText = count;
            if (count > 0) {
                notificationCountSpan.classList.remove('hidden');
            } else {
                notificationCountSpan.classList.add('hidden');
            }
        }

        async function fetchNotificationCount() {
            try {
                const response = await fetch('/notifications/unread_count/');
                const data = await response.json();
                if (response.ok) {
                    updateNotificationCount(data.unread_count);
                } else {
                    console.error('Error fetching notification count:', data.error);
                }
            } catch (error) {
                console.error('Network error fetching notification count:', error);
            }
        }

        async function fetchNotifications() {
            try {
                const response = await fetch('/notifications/list/api/');
                const data = await response.json();
                if (response.ok) {
                    notificationDropdownContent.innerHTML = ''; // Clear existing notifications
                    if (data.notifications.length > 0) {
                        data.notifications.forEach(notification => {
                            const newNotificationDiv = document.createElement('div');
                            newNotificationDiv.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'notification-item');
                            newNotificationDiv.setAttribute('data-notification-id', notification.id);

                            const notificationTitle = document.createElement('p');
                            notificationTitle.classList.add('font-semibold');
                            notificationTitle.innerText = notification.verb;

                            const notificationMessage = document.createElement('p');
                            notificationMessage.innerText = notification.message; // Assuming 'message' field in payload or directly in notification

                            const notificationTime = document.createElement('span');
                            notificationTime.classList.add('text-xs', 'text-gray-500');
                            notificationTime.innerText = new Date(notification.created_at).toLocaleString();

                            const notificationLink = document.createElement('a');
                            notificationLink.href = notification.url || "#";
                            notificationLink.classList.add('text-purple-600', 'hover:underline');
                            notificationLink.innerText = "View Details";

                            newNotificationDiv.appendChild(notificationTitle);
                            newNotificationDiv.appendChild(notificationMessage);
                            newNotificationDiv.appendChild(notificationTime);
                            newNotificationDiv.appendChild(notificationLink);
                            notificationDropdownContent.appendChild(newNotificationDiv);
                        });
                    } else {
                        const noNotificationsLink = document.createElement('a');
                        noNotificationsLink.href = "#";
                        noNotificationsLink.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'no-notifications');
                        noNotificationsLink.innerText = "No new notifications";
                        notificationDropdownContent.appendChild(noNotificationsLink);
                    }
                } else {
                    console.error('Error fetching notifications:', data.error);
                }
            } catch (error) {
                console.error('Network error fetching notifications:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/notifications/mark_read/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('Notifications marked as read:', data.message);
                    fetchNotificationCount(); // Update count after marking as read
                } else {
                    console.error('Error marking notifications as read:', data.error);
                }
            } catch (error) {
                console.error('Network error marking notifications as read:', error);
            }
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Toggle notification dropdown
        notificationBell.addEventListener('click', function() {
            notificationDropdown.classList.toggle('hidden');
            if (!notificationDropdown.classList.contains('hidden')) {
                fetchNotifications(); // Fetch and display notifications when dropdown is opened
            }
        });

        // Mark all as read button listener
        markAllReadBtn.addEventListener('click', function() {
            markAllNotificationsRead();
        });

        // Close dropdown if clicked outside
        window.addEventListener('click', function(e) {
            if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });

        // Initial fetch and periodic polling
        document.addEventListener('DOMContentLoaded', function() {
            fetchNotificationCount(); // Initial fetch
            setInterval(fetchNotificationCount, 30000); // Poll every 30 seconds
        });
    </script>
    {% endif %}
    {% block extra_js %}{% endblock extra_js %} {# New block for extra JavaScript #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
</body>
</html>
