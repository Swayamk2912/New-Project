{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 chat-container">
    <div class="card">
        <div class="card-header chat-header d-flex justify-content-between align-items-center">
            <div>
                Chat with 
                {% for participant in conversation.participants.all %}
                    {% if participant != request.user %}
                        {{ participant.username }}
                    {% endif %}
                {% endfor %}
                {% if job %}
                    - {{ job.title }}
                {% endif %}
            </div>
            <div class="chat-icons mr-2">
                <a href="#" class="video-call-icon"><img src="/static/images/video_call.png" alt="Video Call" width="16" height="16"></a>
                <a href="#" class="call-icon ml-3"><img src="/static/images/call.png" alt="Call" width="16" height="16"></a>
                <button id="delete-conversation-btn" class="btn btn-danger btn-sm ml-3">Delete Conversation</button>
            </div>
        </div>
        <div class="card-body chat-messages" id="chat-log">
            {% for message in messages %}
                {% if not message.is_deleted %}
                    <div class="message-bubble {% if message.sender == request.user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                        <strong>{{ message.sender.username }}</strong>: {{ message.content }}
                        <br>
                        <small class="text-muted">{{ message.timestamp|date:"N j, Y, P" }}</small>
                        {% if message.sender == request.user %}
                            <button class="btn btn-sm btn-outline-danger delete-message-btn" data-message-id="{{ message.id }}">Delete Message</button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="message-bubble deleted-message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                        <em>This message was deleted.</em>
                        <br>
                        <small class="text-muted">{{ message.timestamp|date:"N j, Y, P" }}</small>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="card-footer chat-input-area">
            <form id="chat-form">
                <div class="input-group">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message...">
                    <div class="input-group-append">
                        <button type="submit" id="chat-message-submit" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const conversationId = {{ conversation.id }};
    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.hostname + ':8001'
        + '/ws/chat/'
        + conversationId
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');

        if (data.type === 'chat_message') {
            const messageHtml = `
                <div class="message-bubble ${data.sender === '{{ request.user.username }}' ? 'sent' : 'received'}" data-message-id="${data.message_id}">
                    <strong>${data.sender}</strong>: ${data.message}
                    <br>
                    <small class="text-muted">${new Date(data.timestamp).toLocaleString()}</small>
                    ${data.sender === '{{ request.user.username }}' ? `<button class="btn btn-sm btn-outline-danger delete-message-btn" data-message-id="${data.message_id}">Delete</button>` : ''}
                </div>
            `;
            chatLog.innerHTML += messageHtml;
        } else if (data.type === 'message_deleted') {
            const messageBubble = document.querySelector(`.message-bubble[data-message-id="${data.message_id}"]`);
            if (messageBubble) {
                messageBubble.innerHTML = `<em>This message was deleted.</em><br><small class="text-muted">${new Date(data.timestamp).toLocaleString()}</small>`;
                messageBubble.classList.add('deleted-message');
            }
        } else if (data.type === 'conversation_deleted') {
            alert('This conversation has been deleted.');
            window.location.href = '{% url "messaging:inbox" %}'; // Redirect to inbox
        }
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();

    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault(); // Prevent default form submission
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        const sender = '{{ request.user.username }}';

        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message,
                'sender': sender
            }));
            messageInputDom.value = ''; // Clear the input field
        } else {
            console.error("WebSocket is not open. ReadyState:", chatSocket.readyState);
        }
    };

    // Event listener for deleting individual messages
    document.querySelector('#chat-log').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-message-btn')) {
            const messageId = e.target.dataset.messageId;
            if (confirm('Are you sure you want to delete this message?')) {
            fetch(`/messages/delete_message/${messageId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 'message_id': messageId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // Message deleted successfully, WebSocket will handle UI update
                        console.log('Message deleted successfully');
                    } else {
                        alert('Error deleting message: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
    });

    // Event listener for deleting the entire conversation
    document.querySelector('#delete-conversation-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to delete this entire conversation? This action cannot be undone.')) {
            fetch(`/messages/delete_conversation/${conversationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'conversation_id': conversationId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Conversation deleted successfully, WebSocket will handle UI update
                    console.log('Conversation deleted successfully');
                } else {
                    alert('Error deleting conversation: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
